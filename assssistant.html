<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Chat with Jarvis</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            color: #333;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .chat {
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 8px;
            background-color: #f9f9f9;
            height: 300px;
            overflow-y: auto;
        }
        .chat p {
            margin: 10px 0;
            padding: 5px;
            border-radius: 5px;
        }
        .chat .user {
            background-color: #e0e0e0;
            text-align: right;
        }
        .chat .bot {
            background-color: #d1f7c4;
            text-align: left;
        }
        .button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            font-size: 18px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
        }
        .button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Voice Chat with Jarvis</h2>
        <div id="chat" class="chat"></div>
        <button id="start-btn" class="button">Start Talking</button>
    </div>

    <script>
        const startBtn = document.getElementById("start-btn");
        const chat = document.getElementById("chat");

        // OpenAI API Key (Never expose API key in client-side code like this in production)
        const API_KEY = "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";  // Replace with your actual API Key

        // Initialize Speech Recognition API
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.continuous = false;
        recognition.interimResults = false;

        // Initialize Speech Synthesis API
        const synth = window.speechSynthesis;

        // Start the Speech Recognition when the button is clicked
        startBtn.addEventListener("click", () => {
            console.log('Starting speech recognition...');
            recognition.start();
            startBtn.disabled = true;
            startBtn.innerHTML = "Listening...";
        });

        // Handle speech input and interaction with OpenAI
        recognition.onresult = async (event) => {
            const userInput = event.results[0][0].transcript;
            console.log("User Input:", userInput);  // Log the recognized speech input
            
            // Add the user input to the chat UI
            addMessage(userInput, 'user');
            
            // Call OpenAI API for bot's response
            const botResponse = await getBotResponse(userInput);
            console.log("Bot Response:", botResponse);  // Log the bot's response
            
            // Display bot's response in the chat
            addMessage(botResponse, 'bot');
            
            // Make the bot speak the response
            speak(botResponse);
            
            // Enable the button again and reset text
            startBtn.disabled = false;
            startBtn.innerHTML = "Start Talking";
        };

        recognition.onerror = (event) => {
            console.error("Speech recognition error", event.error);
            startBtn.disabled = false;
            startBtn.innerHTML = "Start Talking";
            
            // Add more specific error handling
            if (event.error === 'no-speech') {
                console.log("No speech detected. Try speaking louder or closer to the microphone.");
            } else if (event.error === 'audio-capture') {
                console.log("No microphone detected.");
            } else if (event.error === 'not-allowed') {
                console.log("Microphone access denied. Check your browser settings.");
            }
        };

        // Function to get bot's response from OpenAI API
        async function getBotResponse(userInput) {
            const conversation = "You: " + userInput + "\nJarvis: ";
            console.log("Sending to API:", conversation);  // Log the conversation prompt being sent

            // Make the API request to OpenAI
            const response = await fetch('https://api.openai.com/v1/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${API_KEY}`  // Ensure you use your correct API key here
                },
                body: JSON.stringify({
                    model: 'text-davinci-003', // Make sure you are using the correct model
                    prompt: conversation,
                    max_tokens: 100,
                    temperature: 0.7
                })
            });

            // Parse the response and log it to check the result
            const data = await response.json();
            console.log("API Response:", data);  // Log the entire response object

            // Extract the response text and trim any unwanted whitespace
            const botResponse = data.choices[0].text.trim();
            console.log("Bot's Final Response:", botResponse);  // Log the final response text
            
            return botResponse;
        }

        // Function to add messages to the chat UI
        function addMessage(message, sender) {
            const messageElement = document.createElement("p");
            messageElement.classList.add(sender);
            messageElement.textContent = message;
            chat.appendChild(messageElement);
            chat.scrollTop = chat.scrollHeight; // Scroll to the bottom
        }

        // Function to speak the bot's response using Speech Synthesis
        function speak(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            synth.speak(utterance);
        }

        // Log available microphone devices (for debugging)
        navigator.mediaDevices.enumerateDevices()
            .then(devices => {
                devices.forEach(device => {
                    if (device.kind === 'audioinput') {
                        console.log("Microphone found: " + device.label);
                    }
                });
            })
            .catch(err => console.error("Error listing devices: ", err));

    </script>
</body>
</html>
